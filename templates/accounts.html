{% extends "base.html" %}

{% block title %}Accounts - GeminiCRM Pro{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Accounts</h1>
        <p class="page-subtitle">Manage your companies and organizations</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-primary" onclick="showAddAccountModal()">
            <span class="material-icons-round">add</span>
            New Account
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(66, 133, 244, 0.1); color: #4285f4;">
            <span class="material-icons-outlined">business</span>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="totalAccounts">0</div>
            <div class="stat-label">Total Accounts</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(52, 168, 83, 0.1); color: #34a853;">
            <span class="material-icons-outlined">verified</span>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="customerAccounts">0</div>
            <div class="stat-label">Customers</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(251, 188, 4, 0.1); color: #fbbc04;">
            <span class="material-icons-outlined">trending_up</span>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="prospectAccounts">0</div>
            <div class="stat-label">Prospects</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(234, 67, 53, 0.1); color: #ea4335;">
            <span class="material-icons-outlined">attach_money</span>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="totalRevenue">$0</div>
            <div class="stat-label">Total Revenue</div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="filters-bar">
    <div class="filter-group">
        <select id="typeFilter" class="filter-select" onchange="filterAccounts()">
            <option value="">All Types</option>
            <option value="prospect">Prospect</option>
            <option value="customer">Customer</option>
            <option value="partner">Partner</option>
            <option value="competitor">Competitor</option>
        </select>
        <select id="industryFilter" class="filter-select" onchange="filterAccounts()">
            <option value="">All Industries</option>
            <option value="Technology">Technology</option>
            <option value="Finance">Finance</option>
            <option value="Healthcare">Healthcare</option>
            <option value="Manufacturing">Manufacturing</option>
            <option value="Retail">Retail</option>
            <option value="Other">Other</option>
        </select>
    </div>
    <div class="search-filter">
        <span class="material-icons-outlined">search</span>
        <input type="text" id="searchAccounts" placeholder="Search accounts..." oninput="filterAccounts()">
    </div>
</div>

<!-- Accounts Table -->
<div class="data-table-container">
    <table class="data-table" id="accountsTable">
        <thead>
            <tr>
                <th>Account Name</th>
                <th>Type</th>
                <th>Industry</th>
                <th>Phone</th>
                <th>Revenue</th>
                <th>Contacts</th>
                <th>Deals</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="accountsTableBody">
            <tr class="loading-row">
                <td colspan="8">
                    <div class="loading-spinner-small"></div>
                    <span>Loading accounts...</span>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Add/Edit Account Modal -->
<div class="modal" id="accountModal">
    <div class="modal-overlay" onclick="closeAccountModal()"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2 id="accountModalTitle">New Account</h2>
            <button class="btn btn-icon btn-ghost" onclick="closeAccountModal()">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <div class="modal-body">
            <form id="accountForm">
                <input type="hidden" id="accountId">
                
                <div class="form-group">
                    <label class="form-label required">Account Name</label>
                    <input type="text" id="accountName" class="form-input" required placeholder="Company name">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" id="accountWebsite" class="form-input" placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="accountPhone" class="form-input" placeholder="+1 (555) 123-4567">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <select id="accountIndustry" class="form-input">
                            <option value="">Select industry</option>
                            <option value="Technology">Technology</option>
                            <option value="Finance">Finance</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Retail">Retail</option>
                            <option value="Education">Education</option>
                            <option value="Consulting">Consulting</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select id="accountType" class="form-input">
                            <option value="prospect">Prospect</option>
                            <option value="customer">Customer</option>
                            <option value="partner">Partner</option>
                            <option value="competitor">Competitor</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Company Size</label>
                        <select id="accountSize" class="form-input">
                            <option value="">Select size</option>
                            <option value="1-10">1-10 employees</option>
                            <option value="11-50">11-50 employees</option>
                            <option value="51-200">51-200 employees</option>
                            <option value="201-500">201-500 employees</option>
                            <option value="500+">500+ employees</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Annual Revenue</label>
                        <input type="number" id="accountRevenue" class="form-input" placeholder="1000000">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="accountDescription" class="form-input" rows="3" placeholder="About this company..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-text" onclick="closeAccountModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveAccount()">
                <span class="material-icons-round">save</span>
                Save Account
            </button>
        </div>
    </div>
</div>

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .page-title h1 {
        margin: 0 0 4px;
        font-size: 28px;
        font-weight: 600;
    }
    
    .page-subtitle {
        margin: 0;
        color: var(--text-secondary, #666);
        font-size: 14px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .stat-card {
        background: var(--surface, #fff);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .stat-icon .material-icons-outlined {
        font-size: 28px;
    }
    
    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary, #202124);
    }
    
    .stat-label {
        font-size: 13px;
        color: var(--text-secondary, #5f6368);
        margin-top: 2px;
    }
    
    .filters-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .filter-group {
        display: flex;
        gap: 12px;
    }
    
    .filter-select {
        padding: 10px 16px;
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: 8px;
        font-size: 14px;
        background: var(--surface, #fff);
        cursor: pointer;
    }
    
    .search-filter {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: 8px;
        background: var(--surface, #fff);
    }
    
    .search-filter input {
        border: none;
        outline: none;
        font-size: 14px;
        min-width: 200px;
    }
    
    .search-filter .material-icons-outlined {
        color: var(--text-secondary, #666);
        font-size: 20px;
    }
    
    .data-table-container {
        background: var(--surface, #fff);
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th {
        text-align: left;
        padding: 16px;
        font-weight: 600;
        color: var(--text-secondary, #5f6368);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: var(--surface-variant, #f8f9fa);
        border-bottom: 1px solid var(--border-color, #e0e0e0);
    }
    
    .data-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
    }
    
    .data-table tbody tr:hover {
        background: var(--surface-variant, #f8f9fa);
    }
    
    .data-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .account-name {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .account-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: var(--primary, #4285f4);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
    }
    
    .account-info strong {
        display: block;
    }
    
    .account-info span {
        font-size: 12px;
        color: var(--text-secondary, #666);
    }
    
    .type-badge {
        display: inline-flex;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .type-badge.customer {
        background: rgba(52, 168, 83, 0.1);
        color: #34a853;
    }
    
    .type-badge.prospect {
        background: rgba(251, 188, 4, 0.1);
        color: #f9a825;
    }
    
    .type-badge.partner {
        background: rgba(66, 133, 244, 0.1);
        color: #4285f4;
    }
    
    .type-badge.competitor {
        background: rgba(234, 67, 53, 0.1);
        color: #ea4335;
    }
    
    .actions-cell {
        display: flex;
        gap: 4px;
    }
    
    .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary, #666);
        transition: all 0.2s;
    }
    
    .action-btn:hover {
        background: var(--surface-variant, #f0f0f0);
        color: var(--primary, #4285f4);
    }
    
    .action-btn.delete:hover {
        color: #ea4335;
    }
    
    .loading-row td {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary, #666);
    }
    
    .loading-spinner-small {
        width: 24px;
        height: 24px;
        border: 3px solid #e0e0e0;
        border-top-color: var(--primary, #4285f4);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 12px;
        vertical-align: middle;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }
    
    .empty-state .material-icons-outlined {
        font-size: 64px;
        color: var(--text-secondary, #999);
        margin-bottom: 16px;
    }
    
    .empty-state h3 {
        margin: 0 0 8px;
        color: var(--text-primary, #333);
    }
    
    .empty-state p {
        margin: 0 0 20px;
        color: var(--text-secondary, #666);
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
    }
    
    .modal-container {
        position: relative;
        background: var(--surface, #fff);
        border-radius: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 20px;
    }
    
    .modal-body {
        padding: 24px;
    }
    
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color, #e0e0e0);
    }
    
    .form-row {
        display: flex;
        gap: 16px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
    }
    
    .form-label.required::after {
        content: ' *';
        color: #ea4335;
    }
    
    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color, #e0e0e0);
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.2s;
        box-sizing: border-box;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary, #4285f4);
    }
    
    textarea.form-input {
        resize: vertical;
    }
    
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }
        
        .filters-bar {
            flex-direction: column;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .filter-select {
            flex: 1;
        }
        
        .search-filter {
            width: 100%;
        }
        
        .search-filter input {
            flex: 1;
        }
    }
</style>

<script>
    let accounts = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        loadAccounts();
    });
    
    function loadAccounts() {
        fetch('/api/accounts')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    accounts = data.accounts || [];
                    updateStats();
                    renderAccounts();
                }
            })
            .catch(err => {
                console.error('Error loading accounts:', err);
                document.getElementById('accountsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <span class="material-icons-outlined">error</span>
                            <h3>Error loading accounts</h3>
                            <p>Please try refreshing the page</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    function updateStats() {
        document.getElementById('totalAccounts').textContent = accounts.length;
        document.getElementById('customerAccounts').textContent = accounts.filter(a => a.account_type === 'customer').length;
        document.getElementById('prospectAccounts').textContent = accounts.filter(a => a.account_type === 'prospect').length;
        
        const totalRev = accounts.reduce((sum, a) => sum + (a.annual_revenue || 0), 0);
        document.getElementById('totalRevenue').textContent = '$' + formatNumber(totalRev);
    }
    
    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }
    
    function formatCurrency(num) {
        return '$' + (num || 0).toLocaleString();
    }
    
    function renderAccounts(filteredAccounts = null) {
        const tbody = document.getElementById('accountsTableBody');
        const displayAccounts = filteredAccounts || accounts;
        
        if (displayAccounts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <span class="material-icons-outlined">business</span>
                            <h3>No accounts yet</h3>
                            <p>Create your first account to start tracking companies</p>
                            <button class="btn btn-primary" onclick="showAddAccountModal()">
                                <span class="material-icons-round">add</span>
                                Add Account
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = displayAccounts.map(account => `
            <tr>
                <td>
                    <div class="account-name">
                        <div class="account-avatar" style="background: ${getColorFromString(account.name)}">
                            ${account.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="account-info">
                            <strong>${escapeHtml(account.name)}</strong>
                            <span>${account.website || '-'}</span>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="type-badge ${account.account_type}">${capitalizeFirst(account.account_type || 'prospect')}</span>
                </td>
                <td>${escapeHtml(account.industry || '-')}</td>
                <td>${escapeHtml(account.phone || '-')}</td>
                <td>${formatCurrency(account.annual_revenue)}</td>
                <td>${account.contacts_count || 0}</td>
                <td>${account.opportunities_count || 0}</td>
                <td>
                    <div class="actions-cell">
                        <button class="action-btn" onclick="editAccount('${account.id}')" title="Edit">
                            <span class="material-icons-outlined">edit</span>
                        </button>
                        <button class="action-btn delete" onclick="deleteAccount('${account.id}')" title="Delete">
                            <span class="material-icons-outlined">delete</span>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    function filterAccounts() {
        const typeFilter = document.getElementById('typeFilter').value;
        const industryFilter = document.getElementById('industryFilter').value;
        const search = document.getElementById('searchAccounts').value.toLowerCase();
        
        const filtered = accounts.filter(a => {
            if (typeFilter && a.account_type !== typeFilter) return false;
            if (industryFilter && a.industry !== industryFilter) return false;
            if (search && !a.name.toLowerCase().includes(search)) return false;
            return true;
        });
        
        renderAccounts(filtered);
    }
    
    function showAddAccountModal() {
        document.getElementById('accountModalTitle').textContent = 'New Account';
        document.getElementById('accountForm').reset();
        document.getElementById('accountId').value = '';
        document.getElementById('accountModal').classList.add('active');
    }
    
    function closeAccountModal() {
        document.getElementById('accountModal').classList.remove('active');
    }
    
    function editAccount(id) {
        const account = accounts.find(a => a.id === id);
        if (!account) return;
        
        document.getElementById('accountModalTitle').textContent = 'Edit Account';
        document.getElementById('accountId').value = account.id;
        document.getElementById('accountName').value = account.name || '';
        document.getElementById('accountWebsite').value = account.website || '';
        document.getElementById('accountPhone').value = account.phone || '';
        document.getElementById('accountIndustry').value = account.industry || '';
        document.getElementById('accountType').value = account.account_type || 'prospect';
        document.getElementById('accountSize').value = account.company_size || '';
        document.getElementById('accountRevenue').value = account.annual_revenue || '';
        document.getElementById('accountDescription').value = account.description || '';
        
        document.getElementById('accountModal').classList.add('active');
    }
    
    function saveAccount() {
        const id = document.getElementById('accountId').value;
        const data = {
            name: document.getElementById('accountName').value,
            website: document.getElementById('accountWebsite').value,
            phone: document.getElementById('accountPhone').value,
            industry: document.getElementById('accountIndustry').value,
            account_type: document.getElementById('accountType').value,
            company_size: document.getElementById('accountSize').value,
            annual_revenue: parseFloat(document.getElementById('accountRevenue').value) || 0,
            description: document.getElementById('accountDescription').value
        };
        
        if (!data.name) {
            showToast('Account name is required', 'error');
            return;
        }
        
        const url = id ? `/api/accounts/${id}` : '/api/accounts';
        const method = id ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast(id ? 'Account updated' : 'Account created', 'success');
                closeAccountModal();
                loadAccounts();
            } else {
                showToast(data.error || 'Error saving account', 'error');
            }
        })
        .catch(() => showToast('Error saving account', 'error'));
    }
    
    function deleteAccount(id) {
        if (!confirm('Are you sure you want to delete this account?')) return;
        
        fetch(`/api/accounts/${id}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Account deleted', 'success');
                    loadAccounts();
                } else {
                    showToast('Error deleting account', 'error');
                }
            })
            .catch(() => showToast('Error deleting account', 'error'));
    }
    
    function getColorFromString(str) {
        const colors = ['#4285f4', '#34a853', '#fbbc04', '#ea4335', '#9334e6', '#00acc1', '#ff6d01', '#e91e63'];
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
    }
    
    function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
