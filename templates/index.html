{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">Sales Dashboard</h1>
        <p class="page-subtitle">AI-powered overview of your sales pipeline</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-primary" id="getAIInsights">
            <span class="material-icons-round">auto_awesome</span>
            Get AI Insights
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">
            <span class="material-icons-outlined">person_search</span>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="statLeads">0</span>
            <span class="stat-label">Total Leads</span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon green">
            <span class="material-icons-outlined">attach_money</span>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="statPipeline">$0</span>
            <span class="stat-label">Pipeline Value</span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon orange">
            <span class="material-icons-outlined">local_fire_department</span>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="statHotLeads">0</span>
            <span class="stat-label">Hot Leads</span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon purple">
            <span class="material-icons-outlined">task_alt</span>
        </div>
        <div class="stat-content">
            <span class="stat-value" id="statTasks">0</span>
            <span class="stat-label">Pending Tasks</span>
        </div>
        <div class="stat-badge" id="statOverdue"></div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="dashboard-grid">
    <!-- AI Insights Panel -->
    <div class="card ai-insights-card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons-round">auto_awesome</span>
                AI Insights
            </div>
            <span class="badge badge-ai">Powered by Gemini 3</span>
        </div>
        <div class="card-body" id="aiInsightsContent">
            <div class="empty-state">
                <span class="material-icons-outlined">insights</span>
                <p>Click "Get AI Insights" to analyze your pipeline</p>
            </div>
        </div>
    </div>
    
    <!-- Pipeline Overview -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons-outlined">view_kanban</span>
                Pipeline Overview
            </div>
            <a href="/pipeline" class="btn btn-text btn-sm">View Pipeline</a>
        </div>
        <div class="card-body">
            <div class="pipeline-mini" id="pipelineMini"></div>
        </div>
    </div>
    
    <!-- Top Leads -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons-outlined">person_search</span>
                Top Leads
            </div>
            <a href="/leads" class="btn btn-text btn-sm">View All</a>
        </div>
        <div class="card-body no-padding">
            <div class="list" id="topLeadsList"></div>
        </div>
    </div>
    
    <!-- Upcoming Tasks -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons-outlined">task_alt</span>
                Upcoming Tasks
            </div>
            <a href="/tasks" class="btn btn-text btn-sm">View All</a>
        </div>
        <div class="card-body no-padding">
            <div class="list" id="upcomingTasksList"></div>
        </div>
    </div>
    
    <!-- Active Deals Table -->
    <div class="card span-2">
        <div class="card-header">
            <div class="card-title">
                <span class="material-icons-outlined">handshake</span>
                Active Deals
            </div>
            <a href="/deals" class="btn btn-text btn-sm">View All</a>
        </div>
        <div class="card-body no-padding">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Deal</th>
                        <th>Value</th>
                        <th>Stage</th>
                        <th>Probability</th>
                        <th>Expected Close</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="dealsTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
    
    document.getElementById('getAIInsights').addEventListener('click', getAIInsights);
});

async function loadDashboard() {
    try {
        // Load stats
        const statsRes = await fetch('/api/dashboard/stats');
        const stats = await statsRes.json();
        
        document.getElementById('statLeads').textContent = stats.total_leads;
        document.getElementById('statPipeline').textContent = formatCurrency(stats.total_pipeline);
        document.getElementById('statHotLeads').textContent = stats.hot_leads;
        document.getElementById('statTasks').textContent = stats.pending_tasks;
        
        if (stats.overdue_tasks > 0) {
            document.getElementById('statOverdue').textContent = `${stats.overdue_tasks} overdue`;
            document.getElementById('statOverdue').classList.add('badge-danger');
        }
        
        // Render pipeline mini
        renderPipelineMini(stats.deals_by_stage, stats.pipeline_stages);
        
        // Load leads
        const leadsRes = await fetch('/api/leads');
        const leadsData = await leadsRes.json();
        renderTopLeads(leadsData.leads.slice(0, 5));
        
        // Load tasks
        const tasksRes = await fetch('/api/tasks?status=pending');
        const tasksData = await tasksRes.json();
        renderUpcomingTasks(tasksData.tasks.slice(0, 5));
        
        // Load deals
        const dealsRes = await fetch('/api/deals');
        const dealsData = await dealsRes.json();
        renderDealsTable(dealsData.deals.filter(d => !['closed_won', 'closed_lost'].includes(d.stage)).slice(0, 5));
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Failed to load dashboard', 'error');
    }
}

function renderPipelineMini(dealsByStage, stages) {
    const container = document.getElementById('pipelineMini');
    const activeStages = stages.filter(s => !['closed_won', 'closed_lost'].includes(s.id));
    
    let html = '<div class="pipeline-stages">';
    activeStages.forEach(stage => {
        const data = dealsByStage[stage.id] || { count: 0, value: 0 };
        html += `
            <div class="pipeline-stage-mini">
                <div class="stage-bar" style="background: ${stage.color}">
                    <span class="stage-count">${data.count}</span>
                </div>
                <span class="stage-name">${stage.name}</span>
                <span class="stage-value">${formatCurrency(data.value)}</span>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function renderTopLeads(leads) {
    const container = document.getElementById('topLeadsList');
    
    if (leads.length === 0) {
        container.innerHTML = '<div class="empty-state small"><p>No leads yet</p></div>';
        return;
    }
    
    let html = '';
    leads.forEach(lead => {
        const scoreClass = lead.score >= 70 ? 'high' : lead.score >= 40 ? 'medium' : 'low';
        html += `
            <div class="list-item" onclick="viewLead('${lead.id}')">
                <div class="avatar" style="background: ${getAvatarColor(lead.name)}">${lead.initials}</div>
                <div class="list-item-content">
                    <div class="list-item-title">${lead.name}</div>
                    <div class="list-item-subtitle">${lead.company}</div>
                </div>
                <div class="score-badge ${scoreClass}">${lead.score}</div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function renderUpcomingTasks(tasks) {
    const container = document.getElementById('upcomingTasksList');
    
    if (tasks.length === 0) {
        container.innerHTML = '<div class="empty-state small"><p>No pending tasks</p></div>';
        return;
    }
    
    let html = '';
    tasks.forEach(task => {
        const overdueClass = task.is_overdue ? 'overdue' : '';
        html += `
            <div class="list-item ${overdueClass}">
                <button class="btn btn-icon btn-ghost task-check" onclick="completeTask('${task.id}', event)">
                    <span class="material-icons-outlined">radio_button_unchecked</span>
                </button>
                <div class="list-item-content">
                    <div class="list-item-title">${task.title}</div>
                    <div class="list-item-subtitle">
                        <span class="task-type">${task.type}</span>
                        ${task.due_date ? `<span class="task-due">${formatDate(task.due_date)}</span>` : ''}
                    </div>
                </div>
                <span class="priority-dot" style="background: ${task.priority_color}"></span>
            </div>
        `;
    });
    container.innerHTML = html;
}

function renderDealsTable(deals) {
    const tbody = document.getElementById('dealsTableBody');
    
    if (deals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">No active deals</td></tr>';
        return;
    }
    
    let html = '';
    deals.forEach(deal => {
        html += `
            <tr onclick="viewDeal('${deal.id}')">
                <td>
                    <div class="deal-name">${deal.name}</div>
                    <div class="deal-company">${deal.company}</div>
                </td>
                <td class="deal-value">${formatCurrency(deal.value)}</td>
                <td>
                    <span class="stage-badge" style="background: ${deal.stage_color}20; color: ${deal.stage_color}">
                        ${formatStage(deal.stage)}
                    </span>
                </td>
                <td>
                    <div class="probability-bar">
                        <div class="probability-fill" style="width: ${deal.probability}%; background: ${deal.stage_color}"></div>
                    </div>
                    <span class="probability-text">${deal.probability}%</span>
                </td>
                <td>${deal.expected_close_date ? formatDate(deal.expected_close_date) : '-'}</td>
                <td>
                    <button class="btn btn-icon btn-ghost" onclick="predictDeal('${deal.id}', event)" title="AI Prediction">
                        <span class="material-icons-round">auto_awesome</span>
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

async function getAIInsights() {
    const container = document.getElementById('aiInsightsContent');
    container.innerHTML = '<div class="loading-inline"><div class="spinner small"></div><span>Analyzing your pipeline...</span></div>';
    
    try {
        const res = await fetch('/api/ai/dashboard-insights');
        const data = await res.json();
        
        if (data.error) {
            container.innerHTML = `<div class="error-state"><span class="material-icons-outlined">error</span><p>${data.error}</p></div>`;
            return;
        }
        
        const insights = data.insights;
        
        let html = `
            <div class="ai-insights">
                <div class="health-score">
                    <div class="health-circle ${insights.health_status}">
                        <span class="health-value">${insights.health_score}</span>
                    </div>
                    <div class="health-label">Pipeline Health</div>
                </div>
                
                <div class="insights-summary">
                    <p>${insights.summary}</p>
                </div>
                
                <div class="insights-section">
                    <h4><span class="material-icons-round">priority_high</span> Top Priorities</h4>
                    <ul>
                        ${insights.top_priorities?.map(p => `<li>${p}</li>`).join('') || '<li>No priorities identified</li>'}
                    </ul>
                </div>
                
                <div class="insights-section">
                    <h4><span class="material-icons-round">lightbulb</span> Key Actions This Week</h4>
                    <ul>
                        ${insights.this_week_actions?.map(a => `<li>${a}</li>`).join('') || '<li>No actions suggested</li>'}
                    </ul>
                </div>
                
                ${insights.warnings?.length ? `
                <div class="insights-section warnings">
                    <h4><span class="material-icons-round">warning</span> Warnings</h4>
                    <ul>
                        ${insights.warnings.map(w => `<li>${w}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                <div class="forecast-box">
                    <h4>30-Day Forecast</h4>
                    <div class="forecast-stats">
                        <div class="forecast-stat">
                            <span class="forecast-value">${insights.forecast_30_days?.expected_closes || 0}</span>
                            <span class="forecast-label">Expected Closes</span>
                        </div>
                        <div class="forecast-stat">
                            <span class="forecast-value">${formatCurrency(insights.forecast_30_days?.expected_revenue || 0)}</span>
                            <span class="forecast-label">Expected Revenue</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error getting AI insights:', error);
        container.innerHTML = '<div class="error-state"><span class="material-icons-outlined">error</span><p>Failed to get insights</p></div>';
    }
}

async function completeTask(taskId, event) {
    event.stopPropagation();
    try {
        await fetch(`/api/tasks/${taskId}/complete`, { method: 'POST' });
        showToast('Task completed!', 'success');
        loadDashboard();
    } catch (error) {
        showToast('Failed to complete task', 'error');
    }
}

async function predictDeal(dealId, event) {
    event.stopPropagation();
    showLoading();
    
    try {
        const res = await fetch('/api/ai/predict-deal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ deal_id: dealId })
        });
        const data = await res.json();
        hideLoading();
        
        if (data.prediction) {
            showPredictionModal(data.prediction);
        }
    } catch (error) {
        hideLoading();
        showToast('Failed to predict deal', 'error');
    }
}

function showPredictionModal(prediction) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-overlay" onclick="this.parentElement.remove()"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3><span class="material-icons-round">auto_awesome</span> AI Deal Prediction</h3>
                <button class="btn btn-icon btn-ghost" onclick="this.closest('.modal').remove()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="prediction-result">
                    <div class="prediction-score ${prediction.predicted_outcome}">
                        <span class="prediction-value">${prediction.win_probability}%</span>
                        <span class="prediction-label">Win Probability</span>
                    </div>
                    
                    <p class="prediction-summary">${prediction.summary}</p>
                    
                    <div class="prediction-section">
                        <h4>Risk Factors</h4>
                        <ul>${prediction.risk_factors?.map(r => `<li>${r}</li>`).join('') || '<li>None identified</li>'}</ul>
                    </div>
                    
                    <div class="prediction-section">
                        <h4>Key Actions to Win</h4>
                        <ul>${prediction.key_actions_to_win?.map(a => `<li>${a}</li>`).join('') || '<li>None suggested</li>'}</ul>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function viewLead(id) {
    window.location.href = `/leads?id=${id}`;
}

function viewDeal(id) {
    window.location.href = `/deals?id=${id}`;
}
</script>
{% endblock %}
