{% extends "base.html" %}
{% block title %}Analytics{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">Analytics</h1>
        <p class="page-subtitle">AI-powered insights and performance metrics</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-primary" onclick="getAIInsights()"><span class="material-icons-round">auto_awesome</span>Refresh AI Insights</button>
    </div>
</div>

<!-- Metrics Cards -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-label">Total Pipeline</div>
        <div class="metric-value" id="metricPipeline">$0</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Weighted Pipeline</div>
        <div class="metric-value" id="metricWeighted">$0</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Average Lead Score</div>
        <div class="metric-value" id="metricAvgScore">0</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Active Deals</div>
        <div class="metric-value" id="metricDeals">0</div>
    </div>
</div>

<!-- AI Insights -->
<div class="card ai-insights-card">
    <div class="card-header">
        <div class="card-title"><span class="material-icons-round">auto_awesome</span> AI-Powered Insights</div>
        <span class="badge badge-ai">Gemini 3</span>
    </div>
    <div class="card-body" id="aiInsightsPanel">
        <div class="empty-state">
            <span class="material-icons-outlined">insights</span>
            <p>Click "Refresh AI Insights" to analyze your data</p>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="charts-grid">
    <div class="card">
        <div class="card-header">
            <div class="card-title">Pipeline by Stage</div>
        </div>
        <div class="card-body">
            <div class="chart-bars" id="pipelineChart"></div>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <div class="card-title">Lead Sources</div>
        </div>
        <div class="card-body">
            <div class="chart-bars" id="sourcesChart"></div>
        </div>
    </div>
</div>

<style>
.metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg); }
.metric-card { background: var(--surface); border: 1px solid var(--outline-variant); border-radius: var(--radius-md); padding: var(--spacing-lg); text-align: center; }
.metric-label { font-size: 0.8125rem; color: var(--on-surface-variant); margin-bottom: var(--spacing-xs); }
.metric-value { font-family: var(--font-family); font-size: 2rem; font-weight: 500; color: var(--on-surface); }
.ai-insights-card { margin-bottom: var(--spacing-lg); }
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); }
.chart-bars { display: flex; flex-direction: column; gap: var(--spacing-sm); }
.chart-bar-row { display: flex; align-items: center; gap: var(--spacing-md); }
.chart-bar-label { width: 100px; font-size: 0.8125rem; color: var(--on-surface-variant); }
.chart-bar-container { flex: 1; height: 24px; background: var(--surface-container-low); border-radius: var(--radius-xs); overflow: hidden; }
.chart-bar-fill { height: 100%; border-radius: var(--radius-xs); display: flex; align-items: center; justify-content: flex-end; padding-right: var(--spacing-sm); color: white; font-size: 0.75rem; font-weight: 500; min-width: 30px; }
.ai-insights-content { display: flex; flex-direction: column; gap: var(--spacing-md); }
.health-banner { display: flex; align-items: center; gap: var(--spacing-lg); padding: var(--spacing-md); background: var(--surface-container-low); border-radius: var(--radius-md); }
.health-circle { width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 600; }
.health-circle.excellent { background: var(--success-container); color: var(--success); }
.health-circle.good { background: var(--info-container); color: var(--google-blue); }
.health-circle.needs_attention { background: var(--warning-container); color: #e37400; }
.health-info { flex: 1; }
.health-status { font-weight: 500; text-transform: capitalize; }
.health-summary { font-size: 0.875rem; color: var(--on-surface-variant); margin-top: 2px; }
.insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-md); }
.insight-box { background: var(--surface-container-low); border-radius: var(--radius-sm); padding: var(--spacing-md); }
.insight-title { display: flex; align-items: center; gap: var(--spacing-sm); font-weight: 500; font-size: 0.875rem; margin-bottom: var(--spacing-sm); }
.insight-title .material-icons-round { font-size: 18px; color: var(--primary); }
.insight-box ul { margin: 0; padding-left: var(--spacing-lg); font-size: 0.875rem; }
.insight-box li { margin-bottom: var(--spacing-xs); }
.forecast-banner { background: linear-gradient(135deg, var(--google-blue), var(--google-purple)); color: white; border-radius: var(--radius-md); padding: var(--spacing-md); display: flex; gap: var(--spacing-xl); }
.forecast-item { text-align: center; }
.forecast-value { font-size: 1.5rem; font-weight: 500; }
.forecast-label { font-size: 0.75rem; opacity: 0.9; }
@media (max-width: 992px) { .metrics-grid { grid-template-columns: repeat(2, 1fr); } .charts-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadMetrics();
    loadCharts();
});

async function loadMetrics() {
    try {
        const res = await fetch('/api/dashboard/stats');
        const data = await res.json();
        document.getElementById('metricPipeline').textContent = formatCurrency(data.total_pipeline);
        document.getElementById('metricWeighted').textContent = formatCurrency(data.weighted_pipeline);
        document.getElementById('metricAvgScore').textContent = data.avg_lead_score.toFixed(0);
        document.getElementById('metricDeals').textContent = data.total_deals;
    } catch (e) { console.error(e); }
}

async function loadCharts() {
    try {
        const [statsRes, leadsRes] = await Promise.all([
            fetch('/api/dashboard/stats'),
            fetch('/api/leads')
        ]);
        const stats = await statsRes.json();
        const leadsData = await leadsRes.json();
        
        // Pipeline chart
        const stages = [
            { id: 'lead', name: 'Lead', color: '#4285f4' },
            { id: 'qualified', name: 'Qualified', color: '#34a853' },
            { id: 'proposal', name: 'Proposal', color: '#fbbc04' },
            { id: 'negotiation', name: 'Negotiation', color: '#ff6d01' }
        ];
        const maxValue = Math.max(...stages.map(s => stats.deals_by_stage[s.id]?.value || 0)) || 1;
        document.getElementById('pipelineChart').innerHTML = stages.map(s => {
            const val = stats.deals_by_stage[s.id]?.value || 0;
            const pct = (val / maxValue * 100).toFixed(0);
            return `
                <div class="chart-bar-row">
                    <span class="chart-bar-label">${s.name}</span>
                    <div class="chart-bar-container">
                        <div class="chart-bar-fill" style="width:${pct}%;background:${s.color}">${formatCurrency(val)}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Sources chart
        const sources = {};
        leadsData.leads.forEach(l => { sources[l.source] = (sources[l.source] || 0) + 1; });
        const sourceEntries = Object.entries(sources).sort((a,b) => b[1] - a[1]);
        const maxCount = sourceEntries[0]?.[1] || 1;
        const colors = ['#4285f4', '#34a853', '#fbbc04', '#ea4335', '#9334e6', '#00acc1'];
        document.getElementById('sourcesChart').innerHTML = sourceEntries.map(([name, count], i) => `
            <div class="chart-bar-row">
                <span class="chart-bar-label">${name}</span>
                <div class="chart-bar-container">
                    <div class="chart-bar-fill" style="width:${(count/maxCount*100).toFixed(0)}%;background:${colors[i%colors.length]}">${count}</div>
                </div>
            </div>
        `).join('');
        
    } catch (e) { console.error(e); }
}

async function getAIInsights() {
    const panel = document.getElementById('aiInsightsPanel');
    panel.innerHTML = '<div class="loading-inline"><div class="spinner small"></div><span>Analyzing your data...</span></div>';
    
    try {
        const res = await fetch('/api/ai/dashboard-insights');
        const data = await res.json();
        
        if (data.error) {
            panel.innerHTML = `<div class="empty-state"><span class="material-icons-outlined">error</span><p>${data.error}</p></div>`;
            return;
        }
        
        const i = data.insights;
        panel.innerHTML = `
            <div class="ai-insights-content">
                <div class="health-banner">
                    <div class="health-circle ${i.health_status}">${i.health_score}</div>
                    <div class="health-info">
                        <div class="health-status">${i.health_status?.replace('_', ' ')}</div>
                        <div class="health-summary">${i.pipeline_summary || i.summary}</div>
                    </div>
                </div>
                
                <div class="insights-grid">
                    ${i.top_priorities?.length ? `
                    <div class="insight-box">
                        <div class="insight-title"><span class="material-icons-round">priority_high</span> Top Priorities</div>
                        <ul>${i.top_priorities.map(p => '<li>'+p+'</li>').join('')}</ul>
                    </div>
                    ` : ''}
                    ${i.this_week_actions?.length ? `
                    <div class="insight-box">
                        <div class="insight-title"><span class="material-icons-round">task_alt</span> This Week</div>
                        <ul>${i.this_week_actions.map(a => '<li>'+a+'</li>').join('')}</ul>
                    </div>
                    ` : ''}
                    ${i.key_insights?.length ? `
                    <div class="insight-box">
                        <div class="insight-title"><span class="material-icons-round">lightbulb</span> Key Insights</div>
                        <ul>${i.key_insights.map(k => '<li>'+k+'</li>').join('')}</ul>
                    </div>
                    ` : ''}
                </div>
                
                ${i.forecast_30_days ? `
                <div class="forecast-banner">
                    <div class="forecast-item">
                        <div class="forecast-value">${i.forecast_30_days.expected_closes || 0}</div>
                        <div class="forecast-label">Expected Closes (30d)</div>
                    </div>
                    <div class="forecast-item">
                        <div class="forecast-value">${formatCurrency(i.forecast_30_days.expected_revenue || 0)}</div>
                        <div class="forecast-label">Expected Revenue</div>
                    </div>
                    <div class="forecast-item">
                        <div class="forecast-value">${i.forecast_30_days.confidence || 'N/A'}</div>
                        <div class="forecast-label">Confidence</div>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    } catch (e) {
        panel.innerHTML = '<div class="empty-state"><span class="material-icons-outlined">error</span><p>Failed to get insights</p></div>';
    }
}
</script>
{% endblock %}
