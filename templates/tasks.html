{% extends "base.html" %}
{% block title %}Tasks{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">Tasks</h1>
        <p class="page-subtitle">Manage your sales activities</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-primary" onclick="openModal('addTaskModal')"><span class="material-icons-round">add</span>Add Task</button>
    </div>
</div>

<div class="tasks-container">
    <div class="tasks-section">
        <h3 class="section-title"><span class="material-icons-round" style="color:var(--error)">schedule</span> Overdue</h3>
        <div class="tasks-list" id="overdueTasks"></div>
    </div>
    <div class="tasks-section">
        <h3 class="section-title"><span class="material-icons-round" style="color:var(--warning)">today</span> Today</h3>
        <div class="tasks-list" id="todayTasks"></div>
    </div>
    <div class="tasks-section">
        <h3 class="section-title"><span class="material-icons-round" style="color:var(--primary)">upcoming</span> Upcoming</h3>
        <div class="tasks-list" id="upcomingTasks"></div>
    </div>
    <div class="tasks-section">
        <h3 class="section-title"><span class="material-icons-round" style="color:var(--success)">check_circle</span> Completed</h3>
        <div class="tasks-list" id="completedTasks"></div>
    </div>
</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="modal">
    <div class="modal-overlay" onclick="closeModal('addTaskModal')"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h3>Add Task</h3>
            <button class="btn btn-icon btn-ghost" onclick="closeModal('addTaskModal')"><span class="material-icons-round">close</span></button>
        </div>
        <div class="modal-body">
            <form id="addTaskForm">
                <div class="form-group"><label class="form-label">Title *</label><input type="text" name="title" class="form-input" required></div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select name="type" class="form-input">
                            <option value="Call">Call</option>
                            <option value="Email">Email</option>
                            <option value="Meeting">Meeting</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Demo">Demo</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select name="priority" class="form-input">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">Due Date</label><input type="date" name="due_date" class="form-input"></div>
                <div class="form-group"><label class="form-label">Description</label><textarea name="description" class="form-input" rows="2"></textarea></div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-text" onclick="closeModal('addTaskModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveTask()">Save</button>
        </div>
    </div>
</div>

<style>
.tasks-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-md); }
.tasks-section { background: var(--surface); border: 1px solid var(--outline-variant); border-radius: var(--radius-md); padding: var(--spacing-md); }
.section-title { display: flex; align-items: center; gap: var(--spacing-sm); font-size: 0.875rem; font-weight: 500; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 1px solid var(--outline-variant); }
.tasks-list { display: flex; flex-direction: column; gap: var(--spacing-sm); min-height: 100px; }
.task-item { display: flex; align-items: flex-start; gap: var(--spacing-sm); padding: var(--spacing-sm); border-radius: var(--radius-sm); background: var(--surface-container-low); }
.task-item.completed { opacity: 0.6; }
.task-item.completed .task-title { text-decoration: line-through; }
.task-check { cursor: pointer; color: var(--on-surface-variant); margin-top: 2px; }
.task-check:hover { color: var(--primary); }
.task-content { flex: 1; }
.task-title { font-weight: 500; font-size: 0.875rem; }
.task-meta { display: flex; gap: var(--spacing-sm); font-size: 0.75rem; color: var(--on-surface-variant); margin-top: 2px; }
.task-type { background: var(--surface-container); padding: 1px 6px; border-radius: var(--radius-xs); }
.priority-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 6px; flex-shrink: 0; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); }
.empty-tasks { text-align: center; padding: var(--spacing-lg); color: var(--on-surface-variant); font-size: 0.875rem; }
</style>
{% endblock %}

{% block scripts %}
<script>
let allTasks = [];

document.addEventListener('DOMContentLoaded', loadTasks);

async function loadTasks() {
    try {
        const res = await fetch('/api/tasks');
        const data = await res.json();
        allTasks = data.tasks;
        renderTasks();
    } catch (e) { showToast('Failed to load tasks', 'error'); }
}

function renderTasks() {
    const today = new Date().toISOString().split('T')[0];
    
    const overdue = allTasks.filter(t => t.status !== 'completed' && t.due_date && t.due_date < today);
    const todayTasks = allTasks.filter(t => t.status !== 'completed' && t.due_date === today);
    const upcoming = allTasks.filter(t => t.status !== 'completed' && (!t.due_date || t.due_date > today));
    const completed = allTasks.filter(t => t.status === 'completed');
    
    document.getElementById('overdueTasks').innerHTML = renderTaskList(overdue, true);
    document.getElementById('todayTasks').innerHTML = renderTaskList(todayTasks);
    document.getElementById('upcomingTasks').innerHTML = renderTaskList(upcoming);
    document.getElementById('completedTasks').innerHTML = renderTaskList(completed, false, true);
}

function renderTaskList(tasks, isOverdue = false, isCompleted = false) {
    if (!tasks.length) return '<div class="empty-tasks">No tasks</div>';
    return tasks.map(t => `
        <div class="task-item ${isCompleted ? 'completed' : ''}">
            <span class="material-icons-round task-check" onclick="toggleTask('${t.id}', ${isCompleted})">${isCompleted ? 'check_circle' : 'radio_button_unchecked'}</span>
            <div class="task-content">
                <div class="task-title">${t.title}</div>
                <div class="task-meta">
                    <span class="task-type">${t.type}</span>
                    ${t.due_date ? `<span>${formatDate(t.due_date)}</span>` : ''}
                </div>
            </div>
            <div class="priority-dot" style="background:${t.priority_color}"></div>
        </div>
    `).join('');
}

async function toggleTask(id, isCompleted) {
    if (isCompleted) return; // Can't uncomplete
    try {
        await fetch(`/api/tasks/${id}/complete`, { method: 'POST' });
        showToast('Task completed!', 'success');
        loadTasks();
    } catch (e) { showToast('Failed to complete task', 'error'); }
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

async function saveTask() {
    const form = document.getElementById('addTaskForm');
    const data = Object.fromEntries(new FormData(form));
    try {
        await fetch('/api/tasks', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        showToast('Task created!', 'success');
        closeModal('addTaskModal');
        form.reset();
        loadTasks();
    } catch (e) { showToast('Failed to create task', 'error'); }
}
</script>
{% endblock %}
