{% extends "base.html" %}
{% block title %}Sales Pipeline - Kanban Board{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <span class="material-icons-round" style="color: var(--primary);">view_kanban</span>
            Sales Pipeline
        </h1>
        <p class="page-subtitle">Drag deals between stages • Real-time updates • AI predictions</p>
    </div>
    <div class="page-actions">
        <div class="pipeline-stats" id="pipelineStats">
            <div class="pipeline-stat">
                <span class="pipeline-stat-value" id="totalDeals">0</span>
                <span class="pipeline-stat-label">Total Deals</span>
            </div>
            <div class="pipeline-stat">
                <span class="pipeline-stat-value" id="totalValue">$0</span>
                <span class="pipeline-stat-label">Pipeline Value</span>
            </div>
            <div class="pipeline-stat">
                <span class="pipeline-stat-value" id="weightedValue">$0</span>
                <span class="pipeline-stat-label">Weighted</span>
            </div>
        </div>
        <button class="btn btn-secondary" onclick="refreshPipeline()">
            <span class="material-icons-round">refresh</span>
            Refresh
        </button>
        <button class="btn btn-primary" onclick="openAddDealModal()">
            <span class="material-icons-round">add</span>
            New Deal
        </button>
    </div>
</div>

<!-- Pipeline Kanban Board -->
<div class="pipeline-board" id="pipelineBoard">
    <!-- Columns generated by JS -->
</div>

<!-- Add/Edit Deal Modal -->
<div id="dealModal" class="modal">
    <div class="modal-overlay" onclick="closeModal('dealModal')"></div>
    <div class="modal-container modal-lg">
        <div class="modal-header">
            <h3 id="dealModalTitle">New Deal</h3>
            <button class="btn btn-icon btn-ghost" onclick="closeModal('dealModal')">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <div class="modal-body">
            <form id="dealForm">
                <input type="hidden" id="dealId" name="id">
                
                <div class="form-row">
                    <div class="form-group flex-2">
                        <label class="form-label">Deal Name *</label>
                        <input type="text" id="dealName" name="name" class="form-input" required placeholder="e.g., Enterprise License - Acme Corp">
                    </div>
                    <div class="form-group flex-1">
                        <label class="form-label">Amount ($) *</label>
                        <input type="number" id="dealAmount" name="amount" class="form-input" required min="0" step="100" placeholder="50000">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Account</label>
                        <select id="dealAccount" name="account_id" class="form-select">
                            <option value="">-- Select Account --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact</label>
                        <select id="dealContact" name="contact_id" class="form-select">
                            <option value="">-- Select Contact --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Stage</label>
                        <select id="dealStage" name="stage" class="form-select">
                            <option value="Prospecting">Prospecting</option>
                            <option value="Qualification">Qualification</option>
                            <option value="Needs Analysis">Needs Analysis</option>
                            <option value="Proposal">Proposal</option>
                            <option value="Negotiation">Negotiation</option>
                            <option value="Closed Won">Closed Won</option>
                            <option value="Closed Lost">Closed Lost</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Close Date</label>
                        <input type="date" id="dealCloseDate" name="close_date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Probability (%)</label>
                        <input type="number" id="dealProbability" name="probability" class="form-input" min="0" max="100" value="20">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Lead Source</label>
                    <select id="dealSource" name="lead_source" class="form-select">
                        <option value="">-- Select Source --</option>
                        <option value="Website">Website</option>
                        <option value="Referral">Referral</option>
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="Trade Show">Trade Show</option>
                        <option value="Cold Call">Cold Call</option>
                        <option value="Partner">Partner</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="dealDescription" name="description" class="form-input" rows="3" placeholder="Add notes about this deal..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-text" onclick="closeModal('dealModal')">Cancel</button>
            <button type="button" class="btn btn-secondary" id="aiPredictBtn" onclick="getAIPrediction()">
                <span class="material-icons-round">auto_awesome</span>
                AI Prediction
            </button>
            <button type="button" class="btn btn-primary" onclick="saveDeal()">
                <span class="material-icons-round">save</span>
                Save Deal
            </button>
        </div>
    </div>
</div>

<!-- Deal Details Sidebar -->
<div id="dealDetailsSidebar" class="details-sidebar">
    <div class="details-sidebar-header">
        <h3 id="detailsDealName">Deal Details</h3>
        <button class="btn btn-icon btn-ghost" onclick="closeDealDetails()">
            <span class="material-icons-round">close</span>
        </button>
    </div>
    <div class="details-sidebar-body" id="dealDetailsContent">
        <!-- Dynamic content -->
    </div>
</div>

<style>
/* Pipeline Styles */
.pipeline-stats {
    display: flex;
    gap: 24px;
    margin-right: 16px;
    padding-right: 16px;
    border-right: 1px solid var(--outline-variant);
}
.pipeline-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
}
.pipeline-stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary);
}
.pipeline-stat-label {
    font-size: 0.75rem;
    color: var(--on-surface-variant);
}

/* Kanban Board */
.pipeline-board {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding-bottom: 16px;
    min-height: calc(100vh - 200px);
}

.pipeline-column {
    flex: 0 0 300px;
    background: var(--surface-container-low);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 220px);
}

.pipeline-column-header {
    padding: 16px;
    border-bottom: 4px solid;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background: var(--surface);
}

.pipeline-column-info {
    flex: 1;
}

.pipeline-column-title {
    font-weight: 600;
    font-size: 0.9375rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.pipeline-column-count {
    background: var(--surface-container);
    color: var(--on-surface-variant);
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.pipeline-column-total {
    font-size: 0.8125rem;
    color: var(--on-surface-variant);
    margin-top: 4px;
}

.pipeline-column-body {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
    min-height: 100px;
}

.pipeline-column-body.sortable-ghost {
    background: var(--primary-container);
}

/* Deal Cards */
.deal-card {
    background: var(--surface);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 10px;
    cursor: grab;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
    border-left: 4px solid transparent;
}

.deal-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.deal-card:active {
    cursor: grabbing;
}

.deal-card.sortable-chosen {
    opacity: 0.9;
    box-shadow: var(--shadow-lg);
    transform: rotate(2deg);
}

.deal-card.sortable-ghost {
    opacity: 0.4;
}

.deal-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.deal-card-name {
    font-weight: 500;
    font-size: 0.9375rem;
    color: var(--on-surface);
    cursor: pointer;
}

.deal-card-name:hover {
    color: var(--primary);
}

.deal-card-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s;
}

.deal-card:hover .deal-card-actions {
    opacity: 1;
}

.deal-card-company {
    font-size: 0.8125rem;
    color: var(--on-surface-variant);
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 8px;
}

.deal-card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 8px;
    border-top: 1px solid var(--outline-variant);
}

.deal-card-value {
    font-weight: 600;
    font-size: 1rem;
    color: var(--google-green);
}

.deal-card-prob {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
}

.prob-bar {
    width: 40px;
    height: 4px;
    background: var(--surface-container);
    border-radius: 2px;
    overflow: hidden;
}

.prob-bar-fill {
    height: 100%;
    background: var(--primary);
    transition: width 0.3s ease;
}

.deal-card-date {
    font-size: 0.75rem;
    color: var(--on-surface-variant);
    display: flex;
    align-items: center;
    gap: 4px;
}

.deal-card-date.overdue {
    color: var(--error);
}

.deal-card-date .material-icons-round {
    font-size: 14px;
}

/* Probability colors */
.deal-card.prob-high { border-left-color: var(--google-green); }
.deal-card.prob-medium { border-left-color: var(--google-yellow); }
.deal-card.prob-low { border-left-color: var(--google-orange); }

/* Details Sidebar */
.details-sidebar {
    position: fixed;
    top: 0;
    right: -450px;
    width: 450px;
    height: 100vh;
    background: var(--surface);
    box-shadow: var(--shadow-xl);
    z-index: 200;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
}

.details-sidebar.open {
    right: 0;
}

.details-sidebar-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--outline-variant);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.details-sidebar-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
}

/* Form enhancements */
.form-row {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
}

.form-row .form-group {
    flex: 1;
    margin-bottom: 0;
}

.form-group.flex-2 { flex: 2; }
.form-group.flex-1 { flex: 1; }

/* Modal sizes */
.modal-lg .modal-container {
    max-width: 700px;
}

/* Empty state for columns */
.pipeline-empty {
    text-align: center;
    padding: 24px;
    color: var(--on-surface-variant);
}

.pipeline-empty .material-icons-round {
    font-size: 48px;
    opacity: 0.3;
    margin-bottom: 8px;
}

/* Add deal button in column */
.add-deal-btn {
    width: 100%;
    padding: 12px;
    border: 2px dashed var(--outline);
    border-radius: 8px;
    background: transparent;
    color: var(--on-surface-variant);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.add-deal-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: var(--primary-container);
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Pipeline stages configuration
const STAGES = [
    { id: 'Prospecting', name: 'Prospecting', color: '#4285f4', icon: 'search' },
    { id: 'Qualification', name: 'Qualification', color: '#00acc1', icon: 'fact_check' },
    { id: 'Needs Analysis', name: 'Needs Analysis', color: '#9334e6', icon: 'psychology' },
    { id: 'Proposal', name: 'Proposal', color: '#fbbc04', icon: 'description' },
    { id: 'Negotiation', name: 'Negotiation', color: '#ff6d01', icon: 'handshake' },
    { id: 'Closed Won', name: 'Closed Won', color: '#34a853', icon: 'celebration' },
    { id: 'Closed Lost', name: 'Closed Lost', color: '#ea4335', icon: 'cancel' }
];

let allDeals = [];
let allAccounts = [];
let allContacts = [];
let sortableInstances = [];

document.addEventListener('DOMContentLoaded', initPipeline);

async function initPipeline() {
    await Promise.all([
        loadDeals(),
        loadAccounts(),
        loadContacts()
    ]);
    renderPipelineBoard();
    initSortable();
}

async function loadDeals() {
    try {
        const res = await fetch('/api/deals');
        const data = await res.json();
        allDeals = data.deals || data.opportunities || [];
        updatePipelineStats();
    } catch (e) {
        console.error('Failed to load deals:', e);
        showToast('Failed to load deals', 'error');
    }
}

async function loadAccounts() {
    try {
        const res = await fetch('/api/accounts');
        const data = await res.json();
        allAccounts = data.accounts || [];
        populateAccountSelect();
    } catch (e) {
        console.error('Failed to load accounts:', e);
    }
}

async function loadContacts() {
    try {
        const res = await fetch('/api/contacts');
        const data = await res.json();
        allContacts = data.contacts || [];
        populateContactSelect();
    } catch (e) {
        console.error('Failed to load contacts:', e);
    }
}

function populateAccountSelect() {
    const select = document.getElementById('dealAccount');
    select.innerHTML = '<option value="">-- Select Account --</option>';
    allAccounts.forEach(acc => {
        select.innerHTML += `<option value="${acc.id}">${acc.name}</option>`;
    });
}

function populateContactSelect() {
    const select = document.getElementById('dealContact');
    select.innerHTML = '<option value="">-- Select Contact --</option>';
    allContacts.forEach(c => {
        const name = `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.email;
        select.innerHTML += `<option value="${c.id}">${name}</option>`;
    });
}

function updatePipelineStats() {
    const activeDeals = allDeals.filter(d => d.stage !== 'Closed Won' && d.stage !== 'Closed Lost');
    const totalValue = activeDeals.reduce((sum, d) => sum + (d.amount || d.value || 0), 0);
    const weightedValue = activeDeals.reduce((sum, d) => {
        const prob = d.probability || 20;
        return sum + ((d.amount || d.value || 0) * prob / 100);
    }, 0);
    
    document.getElementById('totalDeals').textContent = allDeals.length;
    document.getElementById('totalValue').textContent = formatCurrency(totalValue);
    document.getElementById('weightedValue').textContent = formatCurrency(weightedValue);
}

function renderPipelineBoard() {
    const board = document.getElementById('pipelineBoard');
    board.innerHTML = '';
    
    STAGES.forEach(stage => {
        const stageDeals = allDeals.filter(d => d.stage === stage.id);
        const stageTotal = stageDeals.reduce((sum, d) => sum + (d.amount || d.value || 0), 0);
        
        const column = document.createElement('div');
        column.className = 'pipeline-column';
        column.innerHTML = `
            <div class="pipeline-column-header" style="border-bottom-color: ${stage.color}">
                <div class="pipeline-column-info">
                    <div class="pipeline-column-title">
                        <span class="material-icons-round" style="font-size: 18px; color: ${stage.color}">${stage.icon}</span>
                        ${stage.name}
                        <span class="pipeline-column-count">${stageDeals.length}</span>
                    </div>
                    <div class="pipeline-column-total">${formatCurrency(stageTotal)}</div>
                </div>
            </div>
            <div class="pipeline-column-body" data-stage="${stage.id}" id="stage-${stage.id.replace(/\s+/g, '-')}">
                ${stageDeals.length === 0 ? `
                    <div class="pipeline-empty">
                        <span class="material-icons-round">inbox</span>
                        <p>No deals</p>
                    </div>
                ` : stageDeals.map(deal => renderDealCard(deal, stage.color)).join('')}
                <button class="add-deal-btn" onclick="openAddDealModal('${stage.id}')">
                    <span class="material-icons-round">add</span>
                    Add Deal
                </button>
            </div>
        `;
        board.appendChild(column);
    });
}

function renderDealCard(deal, stageColor) {
    const prob = deal.probability || 20;
    const probClass = prob >= 70 ? 'prob-high' : prob >= 40 ? 'prob-medium' : 'prob-low';
    const amount = deal.amount || deal.value || 0;
    const closeDate = deal.close_date ? new Date(deal.close_date) : null;
    const isOverdue = closeDate && closeDate < new Date() && deal.stage !== 'Closed Won' && deal.stage !== 'Closed Lost';
    
    const accountName = deal.account_name || (deal.account_id ? allAccounts.find(a => a.id === deal.account_id)?.name : '') || '';
    
    return `
        <div class="deal-card ${probClass}" data-id="${deal.id}" data-stage="${deal.stage}">
            <div class="deal-card-header">
                <span class="deal-card-name" onclick="openDealDetails('${deal.id}')">${deal.name}</span>
                <div class="deal-card-actions">
                    <button class="btn btn-icon btn-ghost btn-xs" onclick="editDeal('${deal.id}')" title="Edit">
                        <span class="material-icons-round" style="font-size: 16px;">edit</span>
                    </button>
                    <button class="btn btn-icon btn-ghost btn-xs" onclick="deleteDeal('${deal.id}')" title="Delete">
                        <span class="material-icons-round" style="font-size: 16px;">delete</span>
                    </button>
                </div>
            </div>
            ${accountName ? `<div class="deal-card-company">
                <span class="material-icons-round" style="font-size: 14px;">business</span>
                ${accountName}
            </div>` : ''}
            <div class="deal-card-meta">
                <span class="deal-card-value">${formatCurrency(amount)}</span>
                <div class="deal-card-prob">
                    <div class="prob-bar">
                        <div class="prob-bar-fill" style="width: ${prob}%"></div>
                    </div>
                    ${prob}%
                </div>
            </div>
            ${closeDate ? `
                <div class="deal-card-date ${isOverdue ? 'overdue' : ''}">
                    <span class="material-icons-round">event</span>
                    ${closeDate.toLocaleDateString()}
                    ${isOverdue ? ' (Overdue)' : ''}
                </div>
            ` : ''}
        </div>
    `;
}

function initSortable() {
    // Destroy existing instances
    sortableInstances.forEach(s => s.destroy());
    sortableInstances = [];
    
    // Create sortable for each column
    STAGES.forEach(stage => {
        const el = document.getElementById(`stage-${stage.id.replace(/\s+/g, '-')}`);
        if (el) {
            const sortable = new Sortable(el, {
                group: 'deals',
                animation: 200,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                filter: '.add-deal-btn, .pipeline-empty',
                onEnd: async function(evt) {
                    const dealId = evt.item.dataset.id;
                    const newStage = evt.to.dataset.stage;
                    const oldStage = evt.from.dataset.stage;
                    
                    if (newStage !== oldStage) {
                        await updateDealStage(dealId, newStage);
                    }
                }
            });
            sortableInstances.push(sortable);
        }
    });
}

async function updateDealStage(dealId, newStage) {
    try {
        const stageProbabilities = {
            'Prospecting': 10,
            'Qualification': 20,
            'Needs Analysis': 30,
            'Proposal': 50,
            'Negotiation': 75,
            'Closed Won': 100,
            'Closed Lost': 0
        };
        
        const res = await fetch(`/api/deals/${dealId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                stage: newStage,
                probability: stageProbabilities[newStage] || 20
            })
        });
        
        if (res.ok) {
            showToast(`Deal moved to ${newStage}`, 'success');
            // Update local data
            const deal = allDeals.find(d => d.id === dealId);
            if (deal) {
                deal.stage = newStage;
                deal.probability = stageProbabilities[newStage] || 20;
            }
            updatePipelineStats();
            // Re-render to update counts
            renderPipelineBoard();
            initSortable();
        } else {
            showToast('Failed to update deal', 'error');
            // Revert - reload
            await loadDeals();
            renderPipelineBoard();
            initSortable();
        }
    } catch (e) {
        console.error('Error updating deal stage:', e);
        showToast('Failed to update deal', 'error');
    }
}

function openAddDealModal(stage = 'Prospecting') {
    document.getElementById('dealModalTitle').textContent = 'New Deal';
    document.getElementById('dealForm').reset();
    document.getElementById('dealId').value = '';
    document.getElementById('dealStage').value = stage;
    document.getElementById('dealProbability').value = getStageProbability(stage);
    
    // Set default close date to 30 days from now
    const closeDate = new Date();
    closeDate.setDate(closeDate.getDate() + 30);
    document.getElementById('dealCloseDate').value = closeDate.toISOString().split('T')[0];
    
    openModal('dealModal');
}

function getStageProbability(stage) {
    const probs = {
        'Prospecting': 10, 'Qualification': 20, 'Needs Analysis': 30,
        'Proposal': 50, 'Negotiation': 75, 'Closed Won': 100, 'Closed Lost': 0
    };
    return probs[stage] || 20;
}

async function editDeal(dealId) {
    const deal = allDeals.find(d => d.id === dealId);
    if (!deal) return;
    
    document.getElementById('dealModalTitle').textContent = 'Edit Deal';
    document.getElementById('dealId').value = deal.id;
    document.getElementById('dealName').value = deal.name || '';
    document.getElementById('dealAmount').value = deal.amount || deal.value || 0;
    document.getElementById('dealAccount').value = deal.account_id || '';
    document.getElementById('dealContact').value = deal.contact_id || '';
    document.getElementById('dealStage').value = deal.stage || 'Prospecting';
    document.getElementById('dealProbability').value = deal.probability || 20;
    document.getElementById('dealSource').value = deal.lead_source || '';
    document.getElementById('dealDescription').value = deal.description || '';
    
    if (deal.close_date) {
        document.getElementById('dealCloseDate').value = deal.close_date.split('T')[0];
    }
    
    openModal('dealModal');
}

async function saveDeal() {
    const form = document.getElementById('dealForm');
    const dealId = document.getElementById('dealId').value;
    
    const data = {
        name: document.getElementById('dealName').value,
        amount: parseFloat(document.getElementById('dealAmount').value) || 0,
        account_id: document.getElementById('dealAccount').value || null,
        contact_id: document.getElementById('dealContact').value || null,
        stage: document.getElementById('dealStage').value,
        probability: parseInt(document.getElementById('dealProbability').value) || 20,
        lead_source: document.getElementById('dealSource').value || null,
        description: document.getElementById('dealDescription').value || null
    };
    
    const closeDate = document.getElementById('dealCloseDate').value;
    if (closeDate) {
        data.close_date = closeDate + 'T00:00:00';
    }
    
    try {
        const url = dealId ? `/api/deals/${dealId}` : '/api/deals';
        const method = dealId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            showToast(dealId ? 'Deal updated!' : 'Deal created!', 'success');
            closeModal('dealModal');
            await refreshPipeline();
        } else {
            const err = await res.json();
            showToast(err.error || 'Failed to save deal', 'error');
        }
    } catch (e) {
        console.error('Error saving deal:', e);
        showToast('Failed to save deal', 'error');
    }
}

async function deleteDeal(dealId) {
    if (!confirm('Are you sure you want to delete this deal?')) return;
    
    try {
        const res = await fetch(`/api/deals/${dealId}`, { method: 'DELETE' });
        if (res.ok) {
            showToast('Deal deleted', 'success');
            await refreshPipeline();
        } else {
            showToast('Failed to delete deal', 'error');
        }
    } catch (e) {
        showToast('Failed to delete deal', 'error');
    }
}

async function refreshPipeline() {
    await loadDeals();
    renderPipelineBoard();
    initSortable();
}

async function getAIPrediction() {
    const dealData = {
        name: document.getElementById('dealName').value,
        amount: parseFloat(document.getElementById('dealAmount').value) || 0,
        stage: document.getElementById('dealStage').value,
        probability: parseInt(document.getElementById('dealProbability').value) || 20
    };
    
    if (!dealData.name || !dealData.amount) {
        showToast('Please fill in deal name and amount first', 'warning');
        return;
    }
    
    const btn = document.getElementById('aiPredictBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="material-icons-round rotating">sync</span> Analyzing...';
    
    try {
        const res = await fetch('/api/ai/predict-deal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dealData)
        });
        
        const data = await res.json();
        if (data.success && data.result) {
            const prediction = data.result;
            alert(`AI Prediction:\n\nWin Probability: ${prediction.probability || prediction.win_probability || 'N/A'}%\n\nRecommendation: ${prediction.recommendation || prediction.next_steps || 'Focus on building value and addressing customer needs.'}`);
            
            // Optionally update probability
            if (prediction.probability) {
                document.getElementById('dealProbability').value = prediction.probability;
            }
        } else {
            showToast('AI prediction unavailable', 'warning');
        }
    } catch (e) {
        console.error('AI prediction error:', e);
        showToast('AI prediction failed', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons-round">auto_awesome</span> AI Prediction';
    }
}

function openDealDetails(dealId) {
    const deal = allDeals.find(d => d.id === dealId);
    if (!deal) return;
    
    const accountName = deal.account_name || (deal.account_id ? allAccounts.find(a => a.id === deal.account_id)?.name : 'N/A') || 'N/A';
    const contactObj = deal.contact_id ? allContacts.find(c => c.id === deal.contact_id) : null;
    const contactName = contactObj ? `${contactObj.first_name || ''} ${contactObj.last_name || ''}`.trim() : 'N/A';
    
    document.getElementById('detailsDealName').textContent = deal.name;
    document.getElementById('dealDetailsContent').innerHTML = `
        <div class="detail-section">
            <h4>Deal Value</h4>
            <p class="detail-value large">${formatCurrency(deal.amount || deal.value || 0)}</p>
        </div>
        
        <div class="detail-section">
            <h4>Stage</h4>
            <span class="stage-badge" style="background: ${getStageColor(deal.stage)}">${deal.stage}</span>
        </div>
        
        <div class="detail-grid">
            <div class="detail-item">
                <span class="detail-label">Probability</span>
                <span class="detail-value">${deal.probability || 0}%</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Close Date</span>
                <span class="detail-value">${deal.close_date ? new Date(deal.close_date).toLocaleDateString() : 'Not set'}</span>
            </div>
        </div>
        
        <div class="detail-section">
            <h4>Account</h4>
            <p>${accountName}</p>
        </div>
        
        <div class="detail-section">
            <h4>Contact</h4>
            <p>${contactName}</p>
        </div>
        
        ${deal.description ? `
        <div class="detail-section">
            <h4>Description</h4>
            <p>${deal.description}</p>
        </div>
        ` : ''}
        
        <div class="detail-actions">
            <button class="btn btn-primary btn-sm" onclick="editDeal('${deal.id}'); closeDealDetails();">
                <span class="material-icons-round">edit</span> Edit
            </button>
            <button class="btn btn-secondary btn-sm" onclick="logActivity('${deal.id}')">
                <span class="material-icons-round">note_add</span> Log Activity
            </button>
        </div>
    `;
    
    document.getElementById('dealDetailsSidebar').classList.add('open');
}

function closeDealDetails() {
    document.getElementById('dealDetailsSidebar').classList.remove('open');
}

function getStageColor(stage) {
    const s = STAGES.find(st => st.id === stage);
    return s ? s.color : '#9e9e9e';
}

function logActivity(dealId) {
    // Placeholder for activity logging
    showToast('Activity logging coming soon!', 'info');
}

// Stage change updates probability
document.getElementById('dealStage')?.addEventListener('change', function() {
    document.getElementById('dealProbability').value = getStageProbability(this.value);
});
</script>

<style>
/* Additional detail sidebar styles */
.detail-section {
    margin-bottom: 20px;
}
.detail-section h4 {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--on-surface-variant);
    margin-bottom: 4px;
}
.detail-value {
    font-weight: 500;
}
.detail-value.large {
    font-size: 1.5rem;
    color: var(--google-green);
}
.detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
}
.detail-item {
    display: flex;
    flex-direction: column;
}
.detail-label {
    font-size: 0.75rem;
    color: var(--on-surface-variant);
}
.stage-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 999px;
    color: white;
    font-size: 0.8125rem;
    font-weight: 500;
}
.detail-actions {
    display: flex;
    gap: 8px;
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid var(--outline-variant);
}
.rotating {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
                        <div class="pipeline-column-total">${formatCurrency(total)}</div>
                    </div>
                    <span class="pipeline-column-count">${stageDeals.length}</span>
                </div>
                <div class="pipeline-column-body">
                    ${stageDeals.map(deal => `
                        <div class="deal-card" draggable="true" data-id="${deal.id}" ondragstart="onDragStart(event)" ondragend="onDragEnd(event)">
                            <div class="deal-card-name">${deal.name}</div>
                            <div class="deal-card-company">${deal.company}</div>
                            <div class="deal-card-footer">
                                <span class="deal-card-value">${formatCurrency(deal.value)}</span>
                                <span class="deal-card-prob">${deal.probability}%</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
}

let draggedId = null;

function onDragStart(e) {
    draggedId = e.target.dataset.id;
    e.target.classList.add('dragging');
}

function onDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.pipeline-column').forEach(col => col.classList.remove('drag-over'));
}

function onDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function onDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

async function onDrop(e) {
    e.preventDefault();
    const column = e.currentTarget;
    column.classList.remove('drag-over');
    const newStage = column.dataset.stage;
    
    if (draggedId && newStage) {
        try {
            await fetch(`/api/deals/${draggedId}/stage`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ stage: newStage })
            });
            await refreshPipeline();
        } catch (e) { showToast('Failed to update deal', 'error'); }
    }
    draggedId = null;
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
</script>
{% endblock %}
